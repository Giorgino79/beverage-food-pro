{% extends "base.html" %}
{% load static %}
{% load crispy_forms_tags %}

{% block title %}Modifica Dipendente{% endblock %}

{% block page_title %}Modifica Dipendente{% endblock %}

{% block content %}
<div class="card shadow mb-4">
    <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
        <h6 class="m-0 font-weight-bold text-primary"><i class="fas fa-user-edit me-2"></i>Modifica Dipendente: {{ dipen.username }}</h6>
        <div>
            <a href="{% url 'dipendenti:vedidipendente' dipendente.pk %}" class="btn btn-info btn-sm">
                <i class="fas fa-eye me-1"></i> Visualizza
            </a>
            <a href="{% url 'dipendenti:elencodipendenti' %}" class="btn btn-secondary btn-sm">
                <i class="fas fa-arrow-left me-1"></i> Torna all'elenco
            </a>
        </div>
    </div>
    <div class="card-body">
        <form method="post" enctype="multipart/form-data" class="needs-validation" novalidate>
            {% csrf_token %}
            
            <div class="row mb-4">
                <div class="col-12">
                    <h5 class="border-bottom pb-2 mb-3"><i class="fas fa-key me-2"></i>Credenziali di Accesso</h5>
                </div>
                <div class="col-md-4">
                    {{ form.username|as_crispy_field }}
                </div>
                <div class="col-md-8">
                    {{ form.password|as_crispy_field }}
                </div>
            </div>
            
            <div class="row mb-4">
                <div class="col-12">
                    <h5 class="border-bottom pb-2 mb-3"><i class="fas fa-id-card me-2"></i>Dati Personali</h5>
                </div>
                <div class="col-md-3">
                    {{ form.first_name|as_crispy_field }}
                </div>
                <div class="col-md-3">
                    {{ form.last_name|as_crispy_field }}
                </div>
                <div class="col-md-3">
                    {{ form.email|as_crispy_field }}
                </div>
                <div class="col-md-3">
                    {{ form.telefono|as_crispy_field }}
                </div>
                <div class="col-md-6">
                    {{ form.indirizzo|as_crispy_field }}
                </div>
                <div class="col-md-3">
                    {{ form.data_nascita|as_crispy_field }}
                </div>
                <div class="col-md-3">
                    {{ form.data_assunzione|as_crispy_field }}
                </div>
            </div>
            
            <div class="row mb-4">
                <div class="col-12">
                    <h5 class="border-bottom pb-2 mb-3"><i class="fas fa-file-alt me-2"></i>Documenti</h5>
                </div>
                <div class="col-md-3">
                    {{ form.CF|as_crispy_field }}
                </div>
                <div class="col-md-3">
                    {{ form.carta_d_identità|as_crispy_field }}
                </div>
                <div class="col-md-3">
                    {{ form.data_scadenza_ci|as_crispy_field }}
                </div>
                <div class="col-md-3">
                    {{ form.patente_di_guida|as_crispy_field }}
                </div>
                <div class="col-md-2">
                    {{ form.data_scadenza_patente|as_crispy_field }}
                </div>
                <div class="col-md-2">
                    {{ form.categorie_patente|as_crispy_field }}
                </div>
                <div class="col-md-4">
                    {{ form.posizione_inail|as_crispy_field }}
                </div>
                <div class="col-md-4">
                    {{ form.posizione_inps|as_crispy_field }}
                </div>
            </div>
            
            <div class="row mb-4">
                <div class="col-12">
                    <h5 class="border-bottom pb-2 mb-3"><i class="fas fa-camera me-2"></i>Foto e Allegati</h5>
                </div>
                
                <div class="col-md-3">
                    <div class="card mb-3">
                        <div class="card-header bg-light">
                            <h6 class="mb-0"><i class="fas fa-user-circle me-2"></i>Foto Dipendente</h6>
                        </div>
                        <div class="card-body text-center">
                            {% if dipen.foto_dipendente %}
                            <img src="{{ dipen.foto_dipendente.url }}" class="img-thumbnail mb-2" style="max-height: 100px;">
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" name="clear_foto_dipendente" id="clear_foto_dipendente">
                                <label class="form-check-label" for="clear_foto_dipendente">
                                    Rimuovi foto
                                </label>
                            </div>
                            {% else %}
                            <i class="fas fa-user-circle fa-3x text-muted mb-2"></i>
                            <p class="small text-muted">Nessuna foto</p>
                            {% endif %}
                            {{ form.foto_dipendente|as_crispy_field }}
                        </div>
                    </div>
                </div>
                
                <div class="col-md-3">
                    <div class="card mb-3">
                        <div class="card-header bg-light">
                            <h6 class="mb-0"><i class="fas fa-id-card me-2"></i>Carta Identità</h6>
                        </div>
                        <div class="card-body text-center">
                            {% if dipen.foto_carta_identità %}
                            <img src="{{ dipen.foto_carta_identità.url }}" class="img-thumbnail mb-2" style="max-height: 100px;">
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" name="clear_foto_carta_identità" id="clear_foto_carta_identità">
                                <label class="form-check-label" for="clear_foto_carta_identità">
                                    Rimuovi foto
                                </label>
                            </div>
                            {% else %}
                            <i class="fas fa-id-card fa-3x text-muted mb-2"></i>
                            <p class="small text-muted">Nessuna foto</p>
                            {% endif %}
                            {{ form.foto_carta_identità|as_crispy_field }}
                        </div>
                    </div>
                </div>
                
                <div class="col-md-3">
                    <div class="card mb-3">
                        <div class="card-header bg-light">
                            <h6 class="mb-0"><i class="fas fa-id-badge me-2"></i>Codice Fiscale</h6>
                        </div>
                        <div class="card-body text-center">
                            {% if dipen.foto_codice_fiscale %}
                            <img src="{{ dipen.foto_codice_fiscale.url }}" class="img-thumbnail mb-2" style="max-height: 100px;">
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" name="clear_foto_codice_fiscale" id="clear_foto_codice_fiscale">
                                <label class="form-check-label" for="clear_foto_codice_fiscale">
                                    Rimuovi foto
                                </label>
                            </div>
                            {% else %}
                            <i class="fas fa-id-badge fa-3x text-muted mb-2"></i>
                            <p class="small text-muted">Nessuna foto</p>
                            {% endif %}
                            {{ form.foto_codice_fiscale|as_crispy_field }}
                        </div>
                    </div>
                </div>
                
                <div class="col-md-3">
                    <div class="card mb-3">
                        <div class="card-header bg-light">
                            <h6 class="mb-0"><i class="fas fa-id-card-alt me-2"></i>Patente</h6>
                        </div>
                        <div class="card-body text-center">
                            {% if dipen.foto_patente %}
                            <img src="{{ dipen.foto_patente.url }}" class="img-thumbnail mb-2" style="max-height: 100px;">
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" name="clear_foto_patente" id="clear_foto_patente">
                                <label class="form-check-label" for="clear_foto_patente">
                                    Rimuovi foto
                                </label>
                            </div>
                            {% else %}
                            <i class="fas fa-id-card-alt fa-3x text-muted mb-2"></i>
                            <p class="small text-muted">Nessuna foto</p>
                            {% endif %}
                            {{ form.foto_patente|as_crispy_field }}
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="row mb-4">
                <div class="col-12">
                    <h5 class="border-bottom pb-2 mb-3"><i class="fas fa-user-shield me-2"></i>Permessi</h5>
                </div>
                <div class="col-md-4">
                    {{ form.livello|as_crispy_field }}
                </div>
                <div class="col-md-4">
                    {{ form.is_active|as_crispy_field }}
                </div>
                <div class="col-md-4">
                    {{ form.is_staff|as_crispy_field }}
                </div>
            </div>
            
            <div class="row mb-4">
                <div class="col-12">
                    <h5 class="border-bottom pb-2 mb-3"><i class="fas fa-sticky-note me-2"></i>Note</h5>
                </div>
                <div class="col-md-12">
                    {{ form.note|as_crispy_field }}
                </div>
            </div>
            
            <div class="row">
                <div class="col-12 text-center">
                    <button type="submit" class="btn btn-primary btn-lg">
                        <i class="fas fa-save me-2"></i>Salva Modifiche
                    </button>
                    <a href="{% url 'dipendenti:elencodipendenti' %}" class="btn btn-secondary btn-lg ms-2">
                        <i class="fas fa-times me-2"></i>Annulla
                    </a>
                </div>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Attiva la validazione Bootstrap per il form
    (function() {
        'use strict';
        window.addEventListener('load', function() {
            // Prendi tutti i form che necessitano di validazione
            var forms = document.getElementsByClassName('needs-validation');
            // Loop su di essi e previeni l'invio se non validi
            var validation = Array.prototype.filter.call(forms, function(form) {
                form.addEventListener('submit', function(event) {
                    if (form.checkValidity() === false) {
                        event.preventDefault();
                        event.stopPropagation();
                    }
                    form.classList.add('was-validated');
                }, false);
            });
        }, false);
    })();
    
    // Anteprima file quando vengono caricati
    document.addEventListener('DOMContentLoaded', function() {
        const fileInputs = [
            'id_foto_dipendente',
            'id_foto_carta_identità',
            'id_foto_codice_fiscale',
            'id_foto_patente'
        ];
        
        fileInputs.forEach(function(inputId) {
            const input = document.getElementById(inputId);
            if (input) {
                input.addEventListener('change', function() {
                    // Trova il contenitore dell'anteprima (il card-body genitore)
                    const container = this.closest('.card-body');
                    
                    // Rimuovi l'anteprima esistente se presente
                    const existingPreview = container.querySelector('img.preview-new');
                    if (existingPreview) {
                        existingPreview.remove();
                    }
                    
                    // Se c'è un file selezionato, mostra l'anteprima
                    if (this.files && this.files[0]) {
                        const reader = new FileReader();
                        const preview = document.createElement('img');
                        preview.className = 'img-thumbnail mb-2 preview-new';
                        preview.style.maxHeight = '100px';
                        
                        reader.onload = function(e) {
                            preview.src = e.target.result;
                            
                            // Aggiungi l'anteprima sopra il campo di input
                            container.insertBefore(preview, input.parentNode);
                            
                            // Nascondi l'icona e il messaggio "Nessuna foto"
                            const icon = container.querySelector('.fa-3x');
                            const noPhotoText = container.querySelector('.small.text-muted');
                            if (icon) icon.style.display = 'none';
                            if (noPhotoText) noPhotoText.style.display = 'none';
                        }
                        
                        reader.readAsDataURL(this.files[0]);
                    }
                });
            }
        });
    });
</script>
{% endblock %}