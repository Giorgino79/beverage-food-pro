{% extends "base.html" %}
{% load static %}
{% load crispy_forms_tags %}

{% block title %}Aggiorna Giornata{% endblock %}

{% block page_title %}Aggiornamento Giornata Lavorativa{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-8">
        <div class="card shadow mb-4">
            <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between bg-primary text-white">
                <h6 class="m-0 font-weight-bold">
                    <i class="fas fa-calendar-day me-2"></i>Giornata del {{ object.data|date:"d/m/Y" }}
                </h6>
                <div>
                    <span class="badge {% if object.chiudi_giornata %}bg-success{% else %}bg-warning{% endif %}">
                        {% if object.chiudi_giornata %}Chiusa{% else %}In Corso{% endif %}
                    </span>
                </div>
            </div>
            <div class="card-body">
                {% if object.confermata %}
                <div class="alert alert-warning mb-4">
                    <i class="fas fa-exclamation-triangle me-2"></i> Questa giornata è stata confermata e non può essere modificata. 
                    {% if object.confermata_da %}
                    <span class="text-muted">Confermata da: {{ object.confermata_da.get_full_name|default:object.confermata_da.username }}</span>
                    {% endif %}
                </div>
                {% endif %}
                
                <form method="post" class="needs-validation" novalidate {% if object.confermata %}disabled{% endif %}>
                    {% csrf_token %}
                    
                    <!-- Orari lavorativi -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h5 class="border-bottom pb-2 mb-3"><i class="fas fa-clock me-2"></i>Orari Lavorativi</h5>
                        </div>
                    </div>
                    
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="card border-left-warning shadow h-100 py-2">
                                <div class="card-body">
                                    <div class="row no-gutters align-items-center">
                                        <div class="col mr-2">
                                            <div class="text-xs font-weight-bold text-warning text-uppercase mb-3">
                                                <i class="fas fa-sun me-1"></i> Mattina
                                            </div>
                                            
                                            <div class="form-group mb-2">
                                                <label class="small mb-1">Inizio mattina</label>
                                                <div class="input-group">
                                                    <span class="input-group-text"><i class="fas fa-play"></i></span>
                                                    <input type="time" id="id_ora_inizio_mattina" name="ora_inizio_mattina" 
                                                           class="form-control" value="{{ object.ora_inizio_mattina|time:'H:i'|default:'' }}" readonly>
                                                </div>
                                            </div>
                                            
                                            <div class="form-group">
                                                <label class="small mb-1">Fine mattina</label>
                                                <div class="input-group">
                                                    <span class="input-group-text"><i class="fas fa-stop"></i></span>
                                                    {{ form.ora_fine_mattina }}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="card border-left-info shadow h-100 py-2">
                                <div class="card-body">
                                    <div class="row no-gutters align-items-center">
                                        <div class="col mr-2">
                                            <div class="text-xs font-weight-bold text-info text-uppercase mb-3">
                                                <i class="fas fa-moon me-1"></i> Pomeriggio
                                            </div>
                                            
                                            <div class="form-group mb-2">
                                                <label class="small mb-1">Inizio pomeriggio</label>
                                                <div class="input-group">
                                                    <span class="input-group-text"><i class="fas fa-play"></i></span>
                                                    {{ form.ora_inizio_pomeriggio }}
                                                </div>
                                            </div>
                                            
                                            <div class="form-group">
                                                <label class="small mb-1">Fine pomeriggio</label>
                                                <div class="input-group">
                                                    <span class="input-group-text"><i class="fas fa-stop"></i></span>
                                                    {{ form.ora_fine_pomeriggio }}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Gestione assenze -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h5 class="border-bottom pb-2 mb-3"><i class="fas fa-calendar-times me-2"></i>Gestione Assenze</h5>
                        </div>
                        
                        <div class="col-md-6">
                            {{ form.assenza|as_crispy_field }}
                        </div>
                        
                        <div class="col-md-6">
                            <div id="notes-container" style="display: {% if form.instance.assenza != 'nessuna' %}block{% else %}none{% endif %};">
                                {{ form.nota_assenza|as_crispy_field }}
                            </div>
                        </div>
                    </div>
                    
                    <!-- Chiusura giornata -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <div class="card bg-light">
                                <div class="card-body">
                                    <div class="form-check form-switch">
                                        {{ form.chiudi_giornata }}
                                        <label class="form-check-label" for="id_chiudi_giornata">
                                            <strong>Chiudi giornata</strong>
                                        </label>
                                    </div>
                                    <small class="text-muted">
                                        Spunta questa casella per indicare che la giornata è completata. 
                                        Una volta chiusa, la giornata non potrà più essere modificata.
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Pulsanti azione -->
                    <div class="row">
                        <div class="col-12 text-center">
                            <button type="submit" class="btn btn-primary btn-lg" {% if object.confermata %}disabled{% endif %}>
                                <i class="fas fa-save me-2"></i>Salva Modifiche
                            </button>
                            <a href="{% url 'dipendenti:profilo' username=object.operatore.username %}" class="btn btn-secondary btn-lg ms-2">
                                <i class="fas fa-arrow-left me-2"></i>Torna al Profilo
                            </a>
                        </div>
                    </div>
                </form>
                
                <!-- Calcolo ore attuali -->
                {% if object.ora_inizio_mattina %}
                <div class="row mt-5">
                    <div class="col-12">
                        <div class="card bg-light">
                            <div class="card-body">
                                <h6 class="card-title"><i class="fas fa-calculator me-2"></i>Riepilogo Ore</h6>
                                <div class="table-responsive">
                                    <table class="table table-sm table-bordered">
                                        <thead class="table-light">
                                            <tr>
                                                <th>Mattina</th>
                                                <th>Pomeriggio</th>
                                                <th>Totale</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                <td>
                                                    {% if object.ora_inizio_mattina and object.ora_fine_mattina %}
                                                    {{ object.ora_inizio_mattina|time:"H:i" }} - {{ object.ora_fine_mattina|time:"H:i" }}
                                                    {% else %}
                                                    -
                                                    {% endif %}
                                                </td>
                                                <td>
                                                    {% if object.ora_inizio_pomeriggio and object.ora_fine_pomeriggio %}
                                                    {{ object.ora_inizio_pomeriggio|time:"H:i" }} - {{ object.ora_fine_pomeriggio|time:"H:i" }}
                                                    {% else %}
                                                    -
                                                    {% endif %}
                                                </td>
                                                <td class="font-weight-bold">{{ object.daily_hours }}</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                                <small class="text-muted">Le ore sono calcolate in base agli orari inseriti.</small>
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Mostra/nascondi il campo note in base al tipo di assenza
    function toggleNotesField() {
        const assenzaSelect = document.getElementById('id_assenza');
        const notesContainer = document.getElementById('notes-container');
        
        if (assenzaSelect.value !== 'nessuna') {
            notesContainer.style.display = 'block';
        } else {
            notesContainer.style.display = 'none';
        }
    }
    
    // Imposta orario corrente
    function setCurrentTime(fieldId) {
        const now = new Date();
        const hours = String(now.getHours()).padStart(2, '0');
        const minutes = String(now.getMinutes()).padStart(2, '0');
        const timeString = `${hours}:${minutes}`;
        
        document.getElementById(fieldId).value = timeString;
    }
    
    // Inizializza alla prima esecuzione
    document.addEventListener('DOMContentLoaded', function() {
        // Configura l'evento per il select di assenza
        const assenzaSelect = document.getElementById('id_assenza');
        assenzaSelect.addEventListener('change', toggleNotesField);
        toggleNotesField(); // Esegui la prima volta per impostare lo stato iniziale
        
        // Aggiungi pulsanti per impostare l'ora corrente
        const timeFields = ['id_ora_fine_mattina', 'id_ora_inizio_pomeriggio', 'id_ora_fine_pomeriggio'];
        
        timeFields.forEach(fieldId => {
            const field = document.getElementById(fieldId);
            const fieldParent = field.parentElement;
            
            // Crea il pulsante
            const button = document.createElement('button');
            button.type = 'button';
            button.className = 'btn btn-outline-secondary';
            button.innerHTML = '<i class="fas fa-clock"></i>';
            button.title = 'Imposta ora corrente';
            button.addEventListener('click', function() {
                setCurrentTime(fieldId);
            });
            
            // Aggiungi il pulsante al gruppo di input
            fieldParent.appendChild(button);
        });
        
        // Gestione chiusura giornata
        const chiudiGiornataCheck = document.getElementById('id_chiudi_giornata');
        chiudiGiornataCheck.addEventListener('change', function() {
            if (this.checked) {
                if (!confirm('Sei sicuro di voler chiudere la giornata? Una volta chiusa non sarà più possibile modificarla.')) {
                    this.checked = false;
                }
            }
        });
    });
</script>
{% endblock %}