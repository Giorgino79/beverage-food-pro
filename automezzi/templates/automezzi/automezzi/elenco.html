$('body').append(modal);
    new bootstrap.Modal(modal[0]).show();
}

function openQuickEvento() {
    // Implementa modal per evento rapido
    var modal = $(`
        <div class="modal fade" id="quickEventoModal">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Nuovo Evento Rapido</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <!-- Form evento rapido -->
                        <p>Scegli un automezzo per continuare...</p>
                    </div>
                </div>
            </div>
        </div>
    `);
    $('body').append(modal);
    new bootstrap.Modal(modal[0]).show();
}

function openQuickManutenzione() {
    // Implementa modal per manutenzione rapida
    var modal = $(`
        <div class="modal fade" id="quickManutenzioneModal">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Nuova Manutenzione Rapida</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <!-- Form manutenzione rapida -->
                        <p>Scegli un automezzo per continuare...</p>
                    </div>
                </div>
            </div>
        </div>
    `);
    $('body').append(modal);
    new bootstrap.Modal(modal[0]).show();
}

function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

function showNotification(message, type = 'info') {
    var alertClass = 'alert-' + type;
    var icon = type === 'success' ? 'check-circle' : 
               type === 'danger' ? 'exclamation-triangle' : 
               type === 'warning' ? 'exclamation-circle' : 'info-circle';
    
    var alert = $(`
        <div class="alert ${alertClass} alert-dismissible fade show position-fixed" 
             style="top: 20px; right: 20px; z-index: 1055; min-width: 300px;" role="alert">
            <i class="fas fa-${icon} me-2"></i>
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `);
    
    $('body').append(alert);
    
    // Auto-hide dopo 5 secondi
    setTimeout(function() {
        alert.alert('close');
    }, 5000);
}

// Gestione filtri responsive
$(window).on('resize', function() {
    if ($(window).width() >= 992) {
        // Desktop: chiudi offcanvas se aperto
        var offcanvas = bootstrap.Offcanvas.getInstance(document.getElementById('filtriOffcanvas'));
        if (offcanvas) {
            offcanvas.hide();
        }
    }
});

// Print support
$('#btnPrint').on('click', function() {
    window.print();
});

// Enhanced keyboard navigation
$(document).keydown(function(e) {
    // Alt+F for filters
    if (e.altKey && e.keyCode === 70) {
        e.preventDefault();
        var filtriOffcanvas = new bootstrap.Offcanvas(document.getElementById('filtriOffcanvas'));
        filtriOffcanvas.show();
    }
    // Alt+Q for quick actions
    if (e.altKey && e.keyCode === 81) {
        e.preventDefault();
        $('#quickActionModal').modal('show');
    }
    // Escape to close modals
    if (e.keyCode === 27) {
        $('.modal').modal('hide');
        var offcanvas = bootstrap.Offcanvas.getInstance(document.getElementById('filtriOffcanvas'));
        if (offcanvas) {
            offcanvas.hide();
        }
    }
});

// Infinite scroll for large datasets (if enabled)
{% if enable_infinite_scroll %}
var loading = false;
var hasNext = {{ automezzi.has_next|yesno:"true,false" }};
var nextPageUrl = "?page={{ automezzi.next_page_number }}{{ query_string_without_page }}";

$(window).scroll(function() {
    if (!loading && hasNext && $(window).scrollTop() + $(window).height() >= $(document).height() - 100) {
        loading = true;
        loadMoreAutomezzi();
    }
});

function loadMoreAutomezzi() {
    $.get(nextPageUrl)
    .done(function(data) {
        var newContent = $(data).find('#automezzi-container').html();
        $('#automezzi-container').append(newContent);
        
        // Update pagination info
        var paginationData = $(data).find('.pagination-info').data();
        hasNext = paginationData.hasNext;
        nextPageUrl = paginationData.nextUrl;
        
        loading = false;
        
        // Reinitialize tooltips for new content
        $('[data-bs-toggle="tooltip"]').tooltip();
    })
    .fail(function() {
        loading = false;
        showNotification('Errore nel caricamento di automezzi aggiuntivi', 'danger');
    });
}
{% endif %}

// Advanced sorting
$('.sortable-header').on('click', function() {
    var field = $(this).data('field');
    var currentOrder = $(this).data('order') || 'asc';
    var newOrder = currentOrder === 'asc' ? 'desc' : 'asc';
    
    var url = new URL(window.location);
    url.searchParams.set('order_by', (newOrder === 'desc' ? '-' : '') + field);
    url.searchParams.delete('page');
    
    window.location.href = url.toString();
});

// Export with current filters
$('.export-link').on('click', function(e) {
    e.preventDefault();
    var url = $(this).attr('href');
    
    // Add current filters to export URL
    var currentParams = new URLSearchParams(window.location.search);
    var exportUrl = new URL(url, window.location.origin);
    
    for (let [key, value] of currentParams) {
        if (key !== 'page' && key !== 'view') {
            exportUrl.searchParams.set(key, value);
        }
    }
    
    window.open(exportUrl.toString(), '_blank');
});

// Auto-save search in sessionStorage
$('#searchInput').on('input', function() {
    sessionStorage.setItem('automezzi_search', $(this).val());
});

// Restore search on page load
$(window).on('load', function() {
    var savedSearch = sessionStorage.getItem('automezzi_search');
    if (savedSearch && !$('#searchInput').val()) {
        $('#searchInput').val(savedSearch);
    }
});

// Enhanced error handling for AJAX requests
$(document).ajaxError(function(event, xhr, settings, error) {
    console.error('AJAX Error:', error);
    showNotification('Si Ã¨ verificato un errore. Riprova tra qualche istante.', 'danger');
});

// Performance monitoring
function trackUserAction(action, details = {}) {
    // Implementation for analytics/monitoring
    if (window.gtag) {
        gtag('event', action, {
            event_category: 'automezzi',
            ...details
        });
    }
}

// Track filter usage
$('#filtriForm').on('submit', function() {
    var activeFilters = $(this).serializeArray().filter(item => item.value).length;
    trackUserAction('filters_applied', { filter_count: activeFilters });
});

// Track bulk actions
window.bulkActionOriginal = window.bulkAction;
window.bulkAction = function(action) {
    var count = $('.bulk-checkbox:checked').length;
    trackUserAction('bulk_action', { action: action, count: count });
    return bulkActionOriginal(action);
};
</script>

<!-- CSS aggiuntivo per miglioramenti UI -->
<style>
.quick-action-card {
    cursor: pointer;
    transition: all 0.3s ease;
    border: 2px solid transparent;
}

.quick-action-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.15);
    border-color: var(--bs-primary);
}

.sortable-header {
    cursor: pointer;
    user-select: none;
    position: relative;
}

.sortable-header:hover {
    background-color: rgba(0,0,0,0.05);
}

.sortable-header::after {
    content: '\f0dc';
    font-family: 'Font Awesome 5 Free';
    font-weight: 900;
    position: absolute;
    right: 8px;
    opacity: 0.3;
}

.sortable-header.sorted-asc::after {
    content: '\f0de';
    opacity: 1;
}

.sortable-header.sorted-desc::after {
    content: '\f0dd';
    opacity: 1;
}

.bulk-checkbox {
    transform: scale(1.2);
    margin-right: 8px;
}

.automezzo-row.selected {
    background-color: rgba(var(--bs-primary-rgb), 0.1);
    border-left: 4px solid var(--bs-primary);
}

/* Loading states */
.loading-overlay {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(255, 255, 255, 0.8);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
}

/* Print styles */
@media print {
    .no-print {
        display: none !important;
    }
    
    .automezzo-card,
    .table {
        break-inside: avoid;
    }
}

/* Responsive improvements */
@media (max-width: 768px) {
    .stat-card {
        margin-bottom: 1rem;
    }
    
    .btn-group {
        flex-direction: column;
    }
    
    .btn-group .btn {
        border-radius: 0.375rem !important;
        margin-bottom: 0.25rem;
    }
}

/* Animation for new content */
@keyframes fadeInUp {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.fade-in-up {
    animation: fadeInUp 0.5s ease-out;
}

/* Enhanced tooltips */
.tooltip {
    font-size: 0.875rem;
}

.tooltip-inner {
    max-width: 300px;
    text-align: left;
}

/* Accessibility improvements */
.sr-only {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    white-space: nowrap;
    border: 0;
}

/* Focus indicators */
.form-control:focus,
.form-select:focus,
.btn:focus {
    box-shadow: 0 0 0 0.2rem rgba(var(--bs-primary-rgb), 0.25);
}

/* Loading spinner for bulk actions */
.bulk-loading {
    opacity: 0.6;
    pointer-events: none;
}

.bulk-loading::after {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    width: 20px;
    height: 20px;
    margin: -10px 0 0 -10px;
    border: 2px solid #f3f3f3;
    border-top: 2px solid #3498db;
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}
</style>
{% endblock %}