{% extends "base.html" %}

{% load static %}
{% load humanize %}
{% load crispy_forms_tags %}

{% block title %}Dettaglio automezzo: {{ automezzo.targa }}{% endblock %}

{% block content %}
<div class="container py-4">
  <div class="row justify-content-center">
    <div class="col-lg-10">
      <div class="card shadow mb-4">
        <div class="card-header d-flex align-items-center justify-content-between">
          <h5 class="mb-0 text-primary">
            <i class="fas fa-car"></i> Dettaglio automezzo: {{ automezzo.targa }}
          </h5>
          <div>
            <a href="{% url 'automezzi:modifica' automezzo.pk %}" class="btn btn-sm btn-info me-2">
              <i class="fas fa-edit"></i> Modifica
            </a>
            <a href="{% url 'automezzi:lista' %}" class="btn btn-sm btn-secondary">
              <i class="fas fa-arrow-left"></i> Lista automezzi
            </a>
          </div>
        </div>
        <div class="card-body">
          <div class="row mb-4">
            <div class="col-md-6">
              <dl class="row">
                <dt class="col-sm-5">Targa:</dt>
                <dd class="col-sm-7 fw-bold">{{ automezzo.targa }}</dd>

                <dt class="col-sm-5">Marca:</dt>
                <dd class="col-sm-7">{{ automezzo.marca }}</dd>

                <dt class="col-sm-5">Modello:</dt>
                <dd class="col-sm-7">{{ automezzo.modello }}</dd>

                <dt class="col-sm-5">Anno immatricolazione:</dt>
                <dd class="col-sm-7">{{ automezzo.anno_immatricolazione }}</dd>

                <dt class="col-sm-5">Tipo carburante:</dt>
                <dd class="col-sm-7">{{ automezzo.tipo_carburante }}</dd>

                <dt class="col-sm-5">Numero telaio:</dt>
                <dd class="col-sm-7">{{ automezzo.numero_telaio|default:"—" }}</dd>
              </dl>
            </div>
            <div class="col-md-6">
              <dl class="row">
                <dt class="col-sm-6">Assegnato a:</dt>
                <dd class="col-sm-6">
                  {% if automezzo.assegnato_a %}
                    <span class="badge bg-primary">{{ automezzo.assegnato_a.get_full_name|default:automezzo.assegnato_a.username }}</span>
                  {% else %}
                    <span class="text-muted">Non assegnato</span>
                  {% endif %}
                </dd>
                <dt class="col-sm-6">Stato:</dt>
                <dd class="col-sm-6">
                  {% if automezzo.attivo %}
                    <span class="badge bg-success">Attivo</span>
                  {% else %}
                    <span class="badge bg-danger">Non attivo</span>
                  {% endif %}
                  {% if automezzo.disponibile %}
                    <span class="badge bg-primary ms-1">Disponibile</span>
                  {% else %}
                    <span class="badge bg-warning ms-1 text-dark">Non disponibile</span>
                  {% endif %}
                </dd>
                <dt class="col-sm-6">Chilometri iniziali:</dt>
                <dd class="col-sm-6">{{ automezzo.chilometri_iniziali|intcomma }}</dd>
                <dt class="col-sm-6">Chilometri attuali:</dt>
                <dd class="col-sm-6">{{ automezzo.chilometri_attuali|intcomma }}</dd>
                <dt class="col-sm-6">Chilometri totali:</dt>
                <dd class="col-sm-6">{{ automezzo.chilometri_totali|intcomma }}</dd>
                <dt class="col-sm-6">Età veicolo:</dt>
                <dd class="col-sm-6">{{ automezzo.eta }} anni</dd>
              </dl>
            </div>
          </div>

          {% if automezzo.note %}
          <div class="alert alert-info">
            <strong>Note:</strong> {{ automezzo.note|linebreaksbr }}
          </div>
          {% endif %}

          <ul class="nav nav-tabs mb-3" id="automezzoTab" role="tablist">
            <li class="nav-item" role="presentation">
              <a class="nav-link {% if sezione_attiva == 'documenti' %}active{% endif %}" id="documenti-tab" data-bs-toggle="tab" href="#documenti" role="tab">Documenti</a>
            </li>
            <li class="nav-item" role="presentation">
              <a class="nav-link {% if sezione_attiva == 'manutenzioni' %}active{% endif %}" id="manutenzioni-tab" data-bs-toggle="tab" href="#manutenzioni" role="tab">Manutenzioni</a>
            </li>
            <li class="nav-item" role="presentation">
              <a class="nav-link {% if sezione_attiva == 'rifornimenti' %}active{% endif %}" id="rifornimenti-tab" data-bs-toggle="tab" href="#rifornimenti" role="tab">Rifornimenti</a>
            </li>
            <li class="nav-item" role="presentation">
              <a class="nav-link {% if sezione_attiva == 'eventi' %}active{% endif %}" id="eventi-tab" data-bs-toggle="tab" href="#eventi" role="tab">Eventi</a>
            </li>
            <li class="nav-item" role="presentation">
              <a class="nav-link {% if sezione_attiva == 'scadenze' %}active{% endif %}" id="scadenze-tab" data-bs-toggle="tab" href="#scadenze" role="tab">Prossime scadenze</a>
            </li>
          </ul>

          <div class="tab-content" id="automezzoTabContent">
            <!-- Documenti -->
            <div class="tab-pane fade {% if sezione_attiva == 'documenti' %}show active{% endif %}" id="documenti" role="tabpanel">
              {% include "automezzi/automezzi/partials/_documenti.html" with documenti=documenti automezzo=automezzo %}
            </div>
            <!-- Manutenzioni -->
            <div class="tab-pane fade {% if sezione_attiva == 'manutenzioni' %}show active{% endif %}" id="manutenzioni" role="tabpanel">
              {% include "automezzi/automezzi/partials/_manutenzioni.html" with manutenzioni=manutenzioni automezzo=automezzo %}
            </div>
            <!-- Rifornimenti -->
            <div class="tab-pane fade {% if sezione_attiva == 'rifornimenti' %}show active{% endif %}" id="rifornimenti" role="tabpanel">
              {% include "automezzi/automezzi/partials/_rifornimenti.html" with rifornimenti=rifornimenti automezzo=automezzo consumo_medio=consumo_medio costo_medio_litro=costo_medio_litro %}
            </div>
            <!-- Eventi -->
            <div class="tab-pane fade {% if sezione_attiva == 'eventi' %}show active{% endif %}" id="eventi" role="tabpanel">
              {% include "automezzi/automezzi/partials/_eventi.html" with eventi=eventi automezzo=automezzo %}
            </div>
            <!-- Prossime scadenze -->
            <div class="tab-pane fade {% if sezione_attiva == 'scadenze' %}show active{% endif %}" id="scadenze" role="tabpanel">
              {% include "automezzi/automezzi/partials/_scadenze.html" with prossime_scadenze=prossime_scadenze %}
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/style.css' %}">
{% endblock %}

{% block javascripts %}
<!-- Bootstrap Tabs JS e eventuale JS custom -->
<script>
  // Attiva la tab giusta su navigazione via anchor e server-side
  document.addEventListener('DOMContentLoaded', function () {
    var hash = window.location.hash;
    if (hash) {
      var triggerEl = document.querySelector('a[href="' + hash + '"]');
      if (triggerEl) {
        new bootstrap.Tab(triggerEl).show();
      }
    }
  });
</script>
{% endblock %}