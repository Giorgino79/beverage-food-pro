<!-- templates/automezzi/dashboard.html -->
{% extends "automezzi/base_automezzi.html" %}
{% load static %}

{% block page_title %}Dashboard Automezzi{% endblock %}
{% block page_subtitle %}Panoramica generale della flotta aziendale{% endblock %}

{% block header_actions %}
<div class="d-flex gap-2">
    <a href="{% url 'automezzi:scadenze' %}" class="btn btn-warning btn-automezzi">
        <i class="fas fa-exclamation-triangle me-2"></i>Scadenze
    </a>
    <a href="{% url 'automezzi:elenco_automezzi' %}" class="btn btn-info btn-automezzi">
        <i class="fas fa-list me-2"></i>Elenco Completo
    </a>
    {% if perms.automezzi.add_automezzo %}
    <a href="{% url 'automezzi:nuovo_automezzo' %}" class="btn btn-success btn-automezzi">
        <i class="fas fa-plus me-2"></i>Nuovo Automezzo
    </a>
    {% endif %}
</div>
{% endblock %}

{% block breadcrumb_items %}
<li class="breadcrumb-item active" aria-current="page">
    <i class="fas fa-tachometer-alt"></i> Dashboard
</li>
{% endblock %}

{% block main_content %}
<!-- Statistiche principali -->
<div class="row mb-4">
    <div class="col-lg-3 col-md-6">
        <div class="stat-card">
            <div class="stat-icon text-primary">
                <i class="fas fa-car"></i>
            </div>
            <div class="stat-number">{{ stats.totale_automezzi }}</div>
            <div class="stat-label">Automezzi Totali</div>
        </div>
    </div>
    <div class="col-lg-3 col-md-6">
        <div class="stat-card">
            <div class="stat-icon text-success">
                <i class="fas fa-check-circle"></i>
            </div>
            <div class="stat-number">{{ stats.automezzi_attivi }}</div>
            <div class="stat-label">Automezzi Attivi</div>
        </div>
    </div>
    <div class="col-lg-3 col-md-6">
        <div class="stat-card">
            <div class="stat-icon text-info">
                <i class="fas fa-parking"></i>
            </div>
            <div class="stat-number">{{ stats.automezzi_disponibili }}</div>
            <div class="stat-label">Disponibili</div>
        </div>
    </div>
    <div class="col-lg-3 col-md-6">
        <div class="stat-card">
            <div class="stat-icon text-warning">
                <i class="fas fa-clock"></i>
            </div>
            <div class="stat-number">{{ stats.scadenze_prossime }}</div>
            <div class="stat-label">Scadenze (30gg)</div>
        </div>
    </div>
</div>

<!-- Alert urgenti -->
{% if scadenze_urgenti %}
<div class="row mb-4">
    <div class="col-12">
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <i class="fas fa-exclamation-triangle fa-2x float-start me-3 mt-1"></i>
            <h5 class="alert-heading">Attenzione: Scadenze Urgenti!</h5>
            <p class="mb-2">Ci sono <strong>{{ scadenze_urgenti|length }}</strong> documenti in scadenza entro 15 giorni:</p>
            <ul class="mb-3">
                {% for scadenza in scadenze_urgenti|slice:":3" %}
                <li>
                    <strong>{{ scadenza.automezzo.targa }}</strong> - 
                    {{ scadenza.get_tipo_display }} 
                    <span class="text-danger">({{ scadenza.giorni_rimanenti }} giorni)</span>
                </li>
                {% endfor %}
                {% if scadenze_urgenti|length > 3 %}
                <li>... e altri {{ scadenze_urgenti|length|add:"-3" }} documenti</li>
                {% endif %}
            </ul>
            <a href="{% url 'automezzi:scadenze' %}?urgenti=true" class="btn btn-outline-danger btn-sm">
                <i class="fas fa-eye me-1"></i>Visualizza Tutte
            </a>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    </div>
</div>
{% endif %}

<!-- Grafici e metriche -->
<div class="row mb-4">
    <!-- Distribuzione per tipo carburante -->
    <div class="col-lg-6">
        <div class="sezione-dettaglio">
            <div class="sezione-header">
                <h5 class="sezione-title">
                    <i class="fas fa-gas-pump me-2"></i>
                    Distribuzione per Carburante
                </h5>
            </div>
            <div class="sezione-content">
                <canvas id="carburanteChart" height="300"></canvas>
            </div>
        </div>
    </div>
    
    <!-- Età media flotta -->
    <div class="col-lg-6">
        <div class="sezione-dettaglio">
            <div class="sezione-header">
                <h5 class="sezione-title">
                    <i class="fas fa-calendar-alt me-2"></i>
                    Età Media Flotta
                </h5>
            </div>
            <div class="sezione-content">
                <canvas id="etaChart" height="300"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Sezioni principali -->
<div class="row">
    <!-- Lista automezzi recenti -->
    <div class="col-lg-8">
        <div class="sezione-dettaglio">
            <div class="sezione-header d-flex justify-content-between align-items-center">
                <h5 class="sezione-title">
                    <i class="fas fa-car me-2"></i>
                    Automezzi Aggiunti di Recente
                </h5>
                <a href="{% url 'automezzi:elenco_automezzi' %}" class="btn btn-sm btn-outline-primary">
                    <i class="fas fa-list me-1"></i>Vedi Tutti
                </a>
            </div>
            <div class="sezione-content">
                {% if automezzi_recenti %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Targa</th>
                                <th>Marca/Modello</th>
                                <th>Carburante</th>
                                <th>Assegnato a</th>
                                <th>Stato</th>
                                <th>Azioni</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for automezzo in automezzi_recenti %}
                            <tr>
                                <td>
                                    <a href="{% url 'automezzi:dettaglio_automezzo' automezzo.pk %}" class="targa">
                                        {{ automezzo.targa }}
                                    </a>
                                </td>
                                <td>{{ automezzo.marca }} {{ automezzo.modello }}</td>
                                <td>
                                    <span class="badge bg-secondary">{{ automezzo.tipo_carburante.nome }}</span>
                                </td>
                                <td>
                                    {% if automezzo.assegnato_a %}
                                        <i class="fas fa-user me-1"></i>
                                        {{ automezzo.assegnato_a.get_full_name|default:automezzo.assegnato_a.username }}
                                    {% else %}
                                        <span class="text-muted">Non assegnato</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if automezzo.attivo %}
                                        <span class="status-badge status-attivo">Attivo</span>
                                    {% else %}
                                        <span class="status-badge status-inattivo">Inattivo</span>
                                    {% endif %}
                                    {% if automezzo.disponibile %}
                                        <span class="status-badge status-disponibile ms-1">Disponibile</span>
                                    {% else %}
                                        <span class="status-badge status-assegnato ms-1">Assegnato</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="btn-group btn-group-sm" role="group">
                                        <a href="{% url 'automezzi:dettaglio_automezzo' automezzo.pk %}" 
                                           class="btn btn-outline-info" title="Dettagli">
                                            <i class="fas fa-eye"></i>
                                        </a>
                                        {% if perms.automezzi.change_automezzo %}
                                        <a href="{% url 'automezzi:modifica_automezzo' automezzo.pk %}" 
                                           class="btn btn-outline-warning" title="Modifica">
                                            <i class="fas fa-edit"></i>
                                        </a>
                                        {% endif %}
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-4">
                    <i class="fas fa-car fa-3x text-muted mb-3"></i>
                    <p class="text-muted">Nessun automezzo registrato</p>
                    {% if perms.automezzi.add_automezzo %}
                    <a href="{% url 'automezzi:nuovo_automezzo' %}" class="btn btn-primary">
                        <i class="fas fa-plus me-2"></i>Aggiungi Primo Automezzo
                    </a>
                    {% endif %}
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- Sidebar info -->
    <div class="col-lg-4">
        <!-- Scadenze prossime -->
        <div class="sezione-dettaglio mb-3">
            <div class="sezione-header">
                <h5 class="sezione-title">
                    <i class="fas fa-calendar-exclamation me-2"></i>
                    Prossime Scadenze
                </h5>
            </div>
            <div class="sezione-content">
                {% if prossime_scadenze %}
                {% for scadenza in prossime_scadenze %}
                <div class="{% if scadenza.giorni_rimanenti <= 15 %}scadenza-urgente{% elif scadenza.giorni_rimanenti <= 30 %}scadenza-avviso{% else %}scadenza-ok{% endif %}">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <strong>{{ scadenza.automezzo.targa }}</strong><br>
                            <small>{{ scadenza.get_tipo_display }}</small>
                        </div>
                        <div class="text-end">
                            <span class="fw-bold">{{ scadenza.giorni_rimanenti }}</span><br>
                            <small>giorni</small>
                        </div>
                    </div>
                </div>
                {% endfor %}
                <div class="text-center mt-3">
                    <a href="{% url 'automezzi:scadenze' %}" class="btn btn-sm btn-outline-warning">
                        <i class="fas fa-calendar-check me-1"></i>Tutte le Scadenze
                    </a>
                </div>
                {% else %}
                <div class="text-center py-3">
                    <i class="fas fa-check-circle fa-2x text-success mb-2"></i>
                    <p class="text-muted mb-0">Nessuna scadenza nei prossimi 90 giorni</p>
                </div>
                {% endif %}
            </div>
        </div>
        
        <!-- Manutenzioni programmate -->
        <div class="sezione-dettaglio mb-3">
            <div class="sezione-header">
                <h5 class="sezione-title">
                    <i class="fas fa-wrench me-2"></i>
                    Manutenzioni Programmate
                </h5>
            </div>
            <div class="sezione-content">
                {% if manutenzioni_programmate %}
                {% for manutenzione in manutenzioni_programmate %}
                <div class="border-start border-3 border-primary ps-3 mb-3">
                    <div class="d-flex justify-content-between">
                        <strong>{{ manutenzione.automezzo.targa }}</strong>
                        <small class="text-muted">{{ manutenzione.data_prevista|date:"d/m/Y" }}</small>
                    </div>
                    <div class="text-muted small">
                        {{ manutenzione.get_tipo_display }} - €{{ manutenzione.costo_previsto|floatformat:2 }}
                    </div>
                    <div class="small text-truncate">{{ manutenzione.descrizione }}</div>
                </div>
                {% endfor %}
                <div class="text-center mt-3">
                    <a href="{% url 'automezzi:elenco_manutenzioni' %}" class="btn btn-sm btn-outline-primary">
                        <i class="fas fa-tools me-1"></i>Tutte le Manutenzioni
                    </a>
                </div>
                {% else %}
                <div class="text-center py-3">
                    <i class="fas fa-tools fa-2x text-muted mb-2"></i>
                    <p class="text-muted mb-0">Nessuna manutenzione programmata</p>
                </div>
                {% endif %}
            </div>
        </div>
        
        <!-- Consumo medio flotta -->
        <div class="sezione-dettaglio">
            <div class="sezione-header">
                <h5 class="sezione-title">
                    <i class="fas fa-tachometer-alt me-2"></i>
                    Consumo Medio Flotta
                </h5>
            </div>
            <div class="sezione-content text-center">
                {% if consumo_medio_flotta %}
                <div class="display-6 text-primary">{{ consumo_medio_flotta|floatformat:2 }}</div>
                <div class="text-muted">L/100km</div>
                <hr>
                <div class="row text-center">
                    <div class="col-6">
                        <div class="h6 text-success">{{ consumo_migliore|floatformat:2 }}</div>
                        <small class="text-muted">Migliore</small>
                    </div>
                    <div class="col-6">
                        <div class="h6 text-danger">{{ consumo_peggiore|floatformat:2 }}</div>
                        <small class="text-muted">Peggiore</small>
                    </div>
                </div>
                {% else %}
                <i class="fas fa-chart-line fa-2x text-muted mb-2"></i>
                <p class="text-muted mb-0">Dati insufficienti</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Link rapidi -->
<div class="row mt-4">
    <div class="col-12">
        <div class="sezione-dettaglio">
            <div class="sezione-header">
                <h5 class="sezione-title">
                    <i class="fas fa-rocket me-2"></i>
                    Link Rapidi
                </h5>
            </div>
            <div class="sezione-content">
                <div class="row">
                    <div class="col-lg-3 col-md-6 mb-3">
                        <a href="{% url 'automezzi:elenco_rifornimenti' %}" 
                           class="btn btn-outline-primary w-100 py-3">
                            <i class="fas fa-gas-pump fa-2x d-block mb-2"></i>
                            Rifornimenti
                        </a>
                    </div>
                    <div class="col-lg-3 col-md-6 mb-3">
                        <a href="{% url 'automezzi:elenco_eventi' %}" 
                           class="btn btn-outline-warning w-100 py-3">
                            <i class="fas fa-exclamation-triangle fa-2x d-block mb-2"></i>
                            Eventi
                        </a>
                    </div>
                    <div class="col-lg-3 col-md-6 mb-3">
                        <a href="{% url 'automezzi:elenco_tipi_carburante' %}" 
                           class="btn btn-outline-info w-100 py-3">
                            <i class="fas fa-oil-can fa-2x d-block mb-2"></i>
                            Tipi Carburante
                        </a>
                    </div>
                    <div class="col-lg-3 col-md-6 mb-3">
                        <a href="{% url 'automezzi:export_csv' %}" 
                           class="btn btn-outline-success w-100 py-3">
                            <i class="fas fa-download fa-2x d-block mb-2"></i>
                            Export Dati
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block automezzi_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
$(document).ready(function() {
    // Grafico distribuzione carburante
    const ctxCarburante = document.getElementById('carburanteChart').getContext('2d');
    const carburanteChart = new Chart(ctxCarburante, {
        type: 'doughnut',
        data: {
            labels: {{ distribuzione_carburante.labels|safe }},
            datasets: [{
                data: {{ distribuzione_carburante.data|safe }},
                backgroundColor: [
                    '#3498db',
                    '#2ecc71',
                    '#f39c12',
                    '#e74c3c',
                    '#9b59b6',
                    '#1abc9c'
                ],
                borderWidth: 2,
                borderColor: '#fff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });
    
    // Grafico età flotta
    const ctxEta = document.getElementById('etaChart').getContext('2d');
    const etaChart = new Chart(ctxEta, {
        type: 'bar',
        data: {
            labels: {{ distribuzione_eta.labels|safe }},
            datasets: [{
                label: 'Numero Automezzi',
                data: {{ distribuzione_eta.data|safe }},
                backgroundColor: '#3498db',
                borderColor: '#2980b9',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1
                    }
                }
            },
            plugins: {
                legend: {
                    display: false
                }
            }
        }
    });
    
    // Auto-refresh stats ogni 5 minuti
    setInterval(function() {
        $.get('{% url "automezzi:api_dashboard_stats" %}')
        .done(function(data) {
            // Aggiorna contatori
            $('.stat-number').each(function(index) {
                $(this).text(Object.values(data.stats)[index]);
            });
        });
    }, 300000);
    
    // Filtro rapido automezzi
    $('#quick-search').on('keyup', function() {
        const value = $(this).val().toLowerCase();
        $('.automezzo-row').each(function() {
            const text = $(this).text().toLowerCase();
            $(this).toggle(text.indexOf(value) > -1);
        });
    });
});
</script>
{% endblock %}