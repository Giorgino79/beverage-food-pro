<!-- templates/automezzi/base_automezzi.html -->
{% extends "base.html" %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'automezzi/css/automezzi.css' %}">
<style>
    /* CSS specifico per automezzi */
    .automezzi-header {
        background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
        color: white;
        padding: 1.5rem 0;
        margin-bottom: 2rem;
    }
    
    .automezzi-title {
        font-size: 2.5rem;
        font-weight: 600;
        margin-bottom: 0.5rem;
    }
    
    .automezzi-subtitle {
        font-size: 1.1rem;
        opacity: 0.9;
    }
    
    /* Card automezzi */
    .automezzo-card {
        transition: all 0.3s ease;
        border: none;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        border-radius: 10px;
        margin-bottom: 1.5rem;
    }
    
    .automezzo-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 4px 20px rgba(0,0,0,0.15);
    }
    
    .automezzo-card .card-header {
        background: #f8f9fa;
        border-bottom: 2px solid #e9ecef;
        border-radius: 10px 10px 0 0;
        padding: 1rem 1.25rem;
    }
    
    .targa {
        font-size: 1.5rem;
        font-weight: 700;
        color: #2c3e50;
        text-decoration: none;
    }
    
    .targa:hover {
        color: #3498db;
    }
    
    /* Status badges */
    .status-badge {
        padding: 0.4rem 0.8rem;
        border-radius: 20px;
        font-size: 0.85rem;
        font-weight: 500;
    }
    
    .status-attivo {
        background: #d4edda;
        color: #155724;
    }
    
    .status-inattivo {
        background: #f8d7da;
        color: #721c24;
    }
    
    .status-disponibile {
        background: #cce7ff;
        color: #004085;
    }
    
    .status-assegnato {
        background: #fff3cd;
        color: #856404;
    }
    
    /* Navigation tabs */
    .nav-automezzi {
        border-bottom: 2px solid #e9ecef;
        margin-bottom: 1.5rem;
    }
    
    .nav-automezzi .nav-link {
        color: #6c757d;
        font-weight: 500;
        padding: 1rem 1.5rem;
        border: none;
        border-bottom: 3px solid transparent;
    }
    
    .nav-automezzi .nav-link.active {
        color: #3498db;
        border-bottom-color: #3498db;
        background: none;
    }
    
    .nav-automezzi .nav-link:hover {
        color: #3498db;
        border-bottom-color: #3498db;
    }
    
    /* Sezioni dettaglio */
    .sezione-dettaglio {
        background: white;
        border-radius: 10px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        margin-bottom: 1.5rem;
    }
    
    .sezione-header {
        background: #f8f9fa;
        padding: 1rem 1.25rem;
        border-bottom: 1px solid #e9ecef;
        border-radius: 10px 10px 0 0;
    }
    
    .sezione-title {
        font-size: 1.25rem;
        font-weight: 600;
        margin: 0;
        color: #2c3e50;
    }
    
    .sezione-content {
        padding: 1.25rem;
    }
    
    /* Form styles */
    .form-automezzi .form-group {
        margin-bottom: 1.5rem;
    }
    
    .form-automezzi label {
        font-weight: 500;
        color: #2c3e50;
        margin-bottom: 0.5rem;
    }
    
    .form-automezzi .form-control {
        border-radius: 6px;
        border: 1px solid #ced4da;
        padding: 0.75rem;
    }
    
    .form-automezzi .form-control:focus {
        border-color: #3498db;
        box-shadow: 0 0 0 0.2rem rgba(52, 152, 219, 0.25);
    }
    
    /* Buttons */
    .btn-automezzi {
        font-weight: 500;
        padding: 0.75rem 1.5rem;
        border-radius: 6px;
        border: none;
    }
    
    .btn-automezzi-primary {
        background: #3498db;
        color: white;
    }
    
    .btn-automezzi-primary:hover {
        background: #2980b9;
        color: white;
    }
    
    .btn-automezzi-success {
        background: #27ae60;
        color: white;
    }
    
    .btn-automezzi-success:hover {
        background: #229954;
        color: white;
    }
    
    .btn-automezzi-warning {
        background: #f39c12;
        color: white;
    }
    
    .btn-automezzi-warning:hover {
        background: #e67e22;
        color: white;
    }
    
    .btn-automezzi-danger {
        background: #e74c3c;
        color: white;
    }
    
    .btn-automezzi-danger:hover {
        background: #c0392b;
        color: white;
    }
    
    /* Scadenze */
    .scadenza-urgente {
        background: #f8d7da;
        border-left: 4px solid #dc3545;
        padding: 0.75rem;
        border-radius: 4px;
        margin-bottom: 0.5rem;
    }
    
    .scadenza-avviso {
        background: #fff3cd;
        border-left: 4px solid #ffc107;
        padding: 0.75rem;
        border-radius: 4px;
        margin-bottom: 0.5rem;
    }
    
    .scadenza-ok {
        background: #d4edda;
        border-left: 4px solid #28a745;
        padding: 0.75rem;
        border-radius: 4px;
        margin-bottom: 0.5rem;
    }
    
    /* Stats dashboard */
    .stat-card {
        background: white;
        border-radius: 10px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        padding: 1.5rem;
        text-align: center;
        margin-bottom: 1.5rem;
    }
    
    .stat-card .stat-icon {
        font-size: 3rem;
        margin-bottom: 1rem;
    }
    
    .stat-card .stat-icon.text-primary { color: #3498db !important; }
    .stat-card .stat-icon.text-success { color: #27ae60 !important; }
    .stat-card .stat-icon.text-warning { color: #f39c12 !important; }
    .stat-card .stat-icon.text-danger { color: #e74c3c !important; }
    
    .stat-card .stat-number {
        font-size: 2.5rem;
        font-weight: 700;
        color: #2c3e50;
    }
    
    .stat-card .stat-label {
        font-size: 1rem;
        color: #6c757d;
        margin-top: 0.5rem;
    }
    
    /* Media queries */
    @media (max-width: 768px) {
        .automezzi-title {
            font-size: 2rem;
        }
        
        .nav-automezzi .nav-link {
            padding: 0.75rem 1rem;
        }
        
        .automezzo-card {
            margin-bottom: 1rem;
        }
        
        .sezione-dettaglio {
            margin-bottom: 1rem;
        }
    }
    
    /* Print styles */
    @media print {
        .automezzi-header,
        .nav-automezzi,
        .btn,
        .buttons-toolbar {
            display: none !important;
        }
        
        .automezzo-card,
        .sezione-dettaglio {
            box-shadow: none;
            border: 1px solid #ddd;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="automezzi-wrapper">
    <!-- Header principale -->
    <div class="automezzi-header">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h1 class="automezzi-title">
                        <i class="fas fa-car me-3"></i>
                        {% block page_title %}Gestione Automezzi{% endblock %}
                    </h1>
                    <p class="automezzi-subtitle mb-0">
                        {% block page_subtitle %}Sistema di gestione flotta aziendale{% endblock %}
                    </p>
                </div>
                <div class="col-md-4 text-end">
                    {% block header_actions %}
                    <a href="{% url 'automezzi:dashboard' %}" class="btn btn-light btn-automezzi me-2">
                        <i class="fas fa-tachometer-alt me-2"></i>Dashboard
                    </a>
                    {% if perms.automezzi.add_automezzo %}
                    <a href="{% url 'automezzi:nuovo_automezzo' %}" class="btn btn-success btn-automezzi">
                        <i class="fas fa-plus me-2"></i>Nuovo Automezzo
                    </a>
                    {% endif %}
                    {% endblock %}
                </div>
            </div>
        </div>
    </div>

    <!-- Navigation tabs (se necessarie) -->
    {% block navigation_tabs %}{% endblock %}

    <!-- Breadcrumb -->
    {% block breadcrumb %}
    <div class="container">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item">
                    <a href="{% url 'home:index' %}">
                        <i class="fas fa-home"></i> Home
                    </a>
                </li>
                <li class="breadcrumb-item">
                    <a href="{% url 'automezzi:dashboard' %}">
                        <i class="fas fa-car"></i> Automezzi
                    </a>
                </li>
                {% block breadcrumb_items %}{% endblock %}
            </ol>
        </nav>
    </div>
    {% endblock %}

    <!-- Messages -->
    <div class="container">
        {% include 'includes/messages.html' %}
    </div>

    <!-- Main content -->
    <div class="container">
        <div class="row">
            {% block sidebar %}{% endblock %}
            
            <div class="{% if sidebar %}col-md-9{% else %}col-12{% endif %}">
                {% block main_content %}
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    Contenuto principale della pagina automezzi
                </div>
                {% endblock %}
            </div>
        </div>
    </div>

    <!-- Footer actions -->
    {% block footer_actions %}{% endblock %}
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'automezzi/js/automezzi.js' %}"></script>
<script>
// JavaScript globale per automezzi
$(document).ready(function() {
    // Tooltip initialization
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
    
    // Popover initialization
    var popoverTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="popover"]'));
    var popoverList = popoverTriggerList.map(function (popoverTriggerEl) {
        return new bootstrap.Popover(popoverTriggerEl);
    });
    
    // Conferma eliminazione
    $('.btn-delete-confirm').on('click', function(e) {
        var message = $(this).data('confirm-message') || 'Sei sicuro di voler eliminare questo elemento?';
        if (!confirm(message)) {
            e.preventDefault();
            return false;
        }
    });
    
    // Toggle stato disponibilità
    $('.toggle-disponibilita').on('click', function(e) {
        e.preventDefault();
        var url = $(this).attr('href');
        var $btn = $(this);
        var oldText = $btn.html();
        
        $btn.html('<i class="fas fa-spinner fa-spin"></i> Aggiornamento...');
        $btn.prop('disabled', true);
        
        $.post(url, {
            'csrfmiddlewaretoken': $('[name=csrfmiddlewaretoken]').val()
        })
        .done(function(data) {
            if (data.success) {
                location.reload();
            } else {
                alert('Errore: ' + (data.error || 'Operazione fallita'));
                $btn.html(oldText);
                $btn.prop('disabled', false);
            }
        })
        .fail(function() {
            alert('Errore di connessione');
            $btn.html(oldText);
            $btn.prop('disabled', false);
        });
    });
    
    // Auto-refresh scadenze (ogni 30 secondi)
    {% if auto_refresh_scadenze %}
    setInterval(function() {
        if ($('.scadenze-container').length) {
            $.get('{% url "automezzi:api_scadenze" %}')
            .done(function(data) {
                $('.scadenze-container').html(data.html);
            });
        }
    }, 30000);
    {% endif %}
    
    // Filtri smart
    $('#filtro-search').on('keyup', function() {
        var value = $(this).val().toLowerCase();
        $('.filterable-item').each(function() {
            var text = $(this).text().toLowerCase();
            $(this).toggle(text.indexOf(value) > -1);
        });
    });
    
    // Export data
    $('.btn-export').on('click', function(e) {
        e.preventDefault();
        var format = $(this).data('format') || 'csv';
        var url = $(this).attr('href') + '?format=' + format;
        window.open(url, '_blank');
    });
});

// Funzioni utility globali
function formatCurrency(amount) {
    return new Intl.NumberFormat('it-IT', {
        style: 'currency',
        currency: 'EUR'
    }).format(amount);
}

function formatDate(dateString) {
    var date = new Date(dateString);
    return date.toLocaleDateString('it-IT');
}

function showNotification(message, type = 'info') {
    var alertClass = 'alert-' + type;
    var icon = type === 'success' ? 'check-circle' : 
               type === 'danger' ? 'exclamation-triangle' : 
               type === 'warning' ? 'exclamation-circle' : 'info-circle';
    
    var alert = `
        <div class="alert ${alertClass} alert-dismissible fade show" role="alert">
            <i class="fas fa-${icon} me-2"></i>
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `;
    
    $('#messages-container').prepend(alert);
    
    // Auto-hide dopo 5 secondi
    setTimeout(function() {
        $('.alert').first().alert('close');
    }, 5000);
}

// Validazioni form
function validateCodiceFiscale(cf) {
    if (!cf) return true; // Campo opzionale
    
    // Normalizza (maiuscolo, rimuovi spazi)
    cf = cf.toUpperCase().replace(/\s/g, '');
    
    // Verifica lunghezza (16 caratteri o 11 per partita IVA)
    if (cf.length !== 16 && cf.length !== 11) return false;
    
    // Pattern base per CF 16 caratteri
    if (cf.length === 16) {
        return /^[A-Z]{6}\d{2}[A-Z]\d{2}[A-Z]\d{3}[A-Z]$/.test(cf);
    }
    
    // Pattern per P.IVA 11 cifre
    if (cf.length === 11) {
        return /^\d{11}$/.test(cf);
    }
    
    return false;
}

function validateTarga(targa) {
    if (!targa) return false;
    
    // Normalizza (maiuscolo, rimuovi spazi)
    targa = targa.toUpperCase().replace(/\s/g, '');
    
    // Pattern targa italiana standard (AA123BB)
    return /^[A-Z]{2}\d{3}[A-Z]{2}$/.test(targa);
}
</script>
{% block automezzi_js %}{% endblock %}
{% endblock %}